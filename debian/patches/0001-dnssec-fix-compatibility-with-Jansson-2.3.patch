From fe1ca2adda6822aa6f8aaf0cf4316387383fca24 Mon Sep 17 00:00:00 2001
From: Jan Vcelak <jan.vcelak@nic.cz>
Date: Wed, 31 Dec 2014 15:35:15 +0100
Subject: [PATCH 1/3] [dnssec] fix compatibility with Jansson 2.3

---
 configure.ac               | 2 +-
 dnssec/Makefile.am         | 2 +-
 dnssec/lib/kasp/dir/json.h | 7 +++++++
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index a7944fa..4da4550 100644
--- a/configure.ac
+++ b/configure.ac
@@ -100,7 +100,7 @@ fi
 PKG_CHECK_MODULES([gnutls], [gnutls >= 3.0 nettle])
 
 # JSON for DNSSEC status storage
-PKG_CHECK_MODULES([jansson], [jansson >= 2.4])
+PKG_CHECK_MODULES([jansson], [jansson >= 2.3])
 
 # Debug modules
 AC_ARG_ENABLE([debug],
diff --git a/dnssec/Makefile.am b/dnssec/Makefile.am
index 8231674..b837160 100644
--- a/dnssec/Makefile.am
+++ b/dnssec/Makefile.am
@@ -7,7 +7,7 @@ AM_CPPFLAGS = \
 	-I$(srcdir)/lib/dnssec \
 	$(CODE_COVERAGE_CFLAGS) \
 	$(gnutls_CFLAGS) \
-	$(jannson_CFLAGS)
+	$(jansson_CFLAGS)
 
 AM_LDFLAGS = \
 	$(CODE_COVERAGE_LDFLAGS)
diff --git a/dnssec/lib/kasp/dir/json.h b/dnssec/lib/kasp/dir/json.h
index ef803eb..f2518b4 100644
--- a/dnssec/lib/kasp/dir/json.h
+++ b/dnssec/lib/kasp/dir/json.h
@@ -18,6 +18,13 @@
 
 #include <jansson.h>
 
+// Compatibility with Jansson 2.3, json_array_foreach exists since 2.7
+#ifndef json_array_foreach
+#define json_array_foreach(array, index, value) \
+	for(index = 0; \
+		index < json_array_size(array) && (value = json_array_get(array, index)); \
+		index++)
+#endif
 
 static inline void json_decref_ptr(json_t **json_ptr)
 {
-- 
2.1.4

